// Initialize the global variable to store JSON data
let jsonData = [];

// Handle file input and process data based on file type
function handleFile(event) {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const fileContent = e.target.result;
        const dataType = file.type;

        if (dataType.includes('json')) {
            processJSON(fileContent);
        } else if (dataType.includes('csv')) {
            processCSV(fileContent);
        }
    };

    reader.readAsText(file);
}

// Process JSON file and populate the table
function processJSON(fileContent) {
    try {
        jsonData = JSON.parse(fileContent);
        populateColumnSelect(jsonData);
        populateTable();
    } catch (error) {
        console.error('Error parsing JSON:', error);
        alert('Failed to parse JSON file.');
    }
}

// Process CSV file and populate the table
function processCSV(fileContent) {
    const lines = fileContent.split('\n');
    const headers = lines[0].split(',');

    jsonData = lines.slice(1).map(line => {
        const values = line.split(',');
        return headers.reduce((obj, header, index) => {
            obj[header] = values[index];
            return obj;
        }, {});
    });

    populateColumnSelect(jsonData);
    populateTable();
}

// Populate the column selection dropdown based on JSON data
function populateColumnSelect(json) {
    const columnSelect = document.getElementById('column-select');
    const headers = Object.keys(json[0] || {});
    columnSelect.innerHTML = '<option value="">Select Column</option>';
    headers.forEach(header => {
        const option = document.createElement('option');
        option.value = header;
        option.textContent = header;
        columnSelect.appendChild(option);
    });
}

// Populate the table with selected column data
function populateTable() {
    const selectedColumn = document.getElementById('column-select').value;
    const tableBody = document.querySelector('#data-table tbody');
    tableBody.innerHTML = ''; // Clear previous data

    if (!selectedColumn || jsonData.length === 0) {
        return;
    }

    jsonData.forEach(row => {
        const cellValue = row[selectedColumn];
        if (cellValue) {
            const tableRow = document.createElement('tr');
            tableRow.innerHTML = `
                <td>${cellValue}</td>
                <td>
                    <input type="checkbox" class="row-select">
                </td>
            `;
            tableBody.appendChild(tableRow);
        }
    });
}

// Copy selected phone numbers to clipboard
function copySelectedRows() {
    const selectedCheckboxes = document.querySelectorAll('#data-table tbody .row-select:checked');
    const phoneNumbers = Array.from(selectedCheckboxes).map(checkbox => {
        const row = checkbox.closest('tr');
        return row.querySelector('td').innerText;
    }).join('\n');

    if (phoneNumbers) {
        navigator.clipboard.writeText(phoneNumbers).then(() => {
            alert('Selected phone numbers copied to clipboard.');
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    } else {
        alert('No phone numbers selected.');
    }
}

// Share selected phone numbers
function shareSelectedRows() {
    const selectedCheckboxes = document.querySelectorAll('#data-table tbody .row-select:checked');
    const phoneNumbers = Array.from(selectedCheckboxes).map(checkbox => {
        const row = checkbox.closest('tr');
        return row.querySelector('td').innerText;
    }).join('\n');

    if (phoneNumbers) {
        const shareData = {
            title: 'Shared Phone Numbers',
            text: phoneNumbers
        };
        navigator.share(shareData).then(() => {
            alert('Shared successfully.');
        }).catch(err => {
            console.error('Failed to share data: ', err);
        });
    } else {
        alert('No phone numbers selected to share.');
    }
}

// Function to handle row selection (for copying or sharing)
document.querySelector('#data-table').addEventListener('click', function(event) {
    if (event.target.classList.contains('row-select')) {
        const row = event.target.closest('tr');
        row.classList.toggle('selected', event.target.checked);
    }
});

// Additional functions to manage table and settings

function sortTable(order) {
    const table = document.getElementById('data-table');
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    rows.sort((a, b) => {
        const aText = a.querySelector('td').innerText;
        const bText = b.querySelector('td').innerText;
        return order === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
    });
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

function filterTable() {
    const filter = prompt('Enter filter text:');
    if (filter) {
        const rows = document.querySelectorAll('#data-table tbody tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(filter.toLowerCase()) ? '' : 'none';
        });
    }
}

function highlightDuplicates() {
    const rows = document.querySelectorAll('#data-table tbody tr');
    const seen = new Set();
    rows.forEach(row => {
        const cell = row.querySelector('td').innerText;
        if (seen.has(cell)) {
            row.style.backgroundColor = '#ffdddd';
        } else {
            seen.add(cell);
        }
    });
}

function addRow() {
    const tableBody = document.querySelector('#data-table tbody');
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>New Data</td>
        <td>
            <input type="checkbox" class="row-select">
        </td>
    `;
    tableBody.appendChild(row);
}

function removeRow() {
    const selectedRows = document.querySelectorAll('#data-table tbody tr.selected');
    selectedRows.forEach(row => row.remove());
}

function updateRow() {
    const selectedRows = document.querySelectorAll('#data-table tbody tr.selected');
    selectedRows.forEach(row => {
        const cell = row.querySelector('td');
        cell.innerText = prompt('Enter new data:', cell.innerText);
    });
}

function addColumn() {
    const table = document.getElementById('data-table');
    const headers = table.querySelectorAll('thead th');
    const newHeader = document.createElement('th');
    newHeader.innerText = 'New Column';
    headers[0].parentNode.appendChild(newHeader);

    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const newCell = document.createElement('td');
        newCell.innerText = 'New Data';
        row.appendChild(newCell);
    });
}

function removeColumn() {
    const table = document.getElementById('data-table');
    const headers = table.querySelectorAll('thead th');
    const lastHeader = headers[headers.length - 1];
    if (lastHeader) {
        lastHeader.remove();
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => row.lastChild.remove());
    }
}

function updateColumn() {
    const column = prompt('Enter column index (0-based):');
    const table = document.getElementById('data-table');
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(row => {
        const cell = row.children[column];
        if (cell) {
            cell.innerText = prompt('Enter new data:', cell.innerText);
        }
    });
}

function printTable() {
    const table = document.getElementById('data-table').outerHTML;
    const newWindow = window.open('', '', 'width=800,height=600');
    newWindow.document.write(`<html><head><title>Print Table</title></head><body>${table}</body></html>`);
    newWindow.document.close();
    newWindow.print();
}

function resetTable() {
    document.querySelector('#data-table tbody').innerHTML = '';
}

function searchInTable() {
    const search = prompt('Enter search text:');
    if (search) {
        const rows = document.querySelectorAll('#data-table tbody tr');
        rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(search.toLowerCase()) ? '' : 'none';
        });
    }
}

function toggleTableVisibility() {
    const table = document.getElementById('data-table');
    table.style.display = table.style.display === 'none' ? '' : 'none';
}

function addComment() {
    const comment = prompt('Enter comment:');
    const selectedRows = document.querySelectorAll('#data-table tbody tr.selected');
    selectedRows.forEach(row => {
        const cell = row.querySelector('td');
        cell.innerHTML += `<div class="comment">${comment}</div>`;
    });
}

function clearFilters() {
    const rows = document.querySelectorAll('#data-table tbody tr');
    rows.forEach(row => row.style.display = '');
}

function toggleSettingsMenu() {
    const menu = document.getElementById('settingsMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function toggleAccessibilityMenu() {
    const menu = document.getElementById('accessibilityMenu');
    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
}

function adjustFontSize(action) {
    const body = document.body;
    let currentSize = window.getComputedStyle(body).fontSize;
    let newSize = parseFloat(currentSize);
    if (action === 'increase') newSize += 2;
    else if (action === 'decrease') newSize -= 2;
    else newSize = 16; // Reset size
    body.style.fontSize = newSize + 'px';
}

function dialNumber(number) {
    alert(`Dialing number: ${number}`);
}

function openDialer(number) {
    alert(`Opening dialer to save number: ${number}`);
}

function downloadVCard(number) {
    const vCardData = `BEGIN:VCARD\nVERSION:3.0\nFN:${number}\nTEL:${number}\nEND:VCARD`;
    const blob = new Blob([vCardData], { type: 'text/vcard' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${number}.vcf`;
    link.click();
}
